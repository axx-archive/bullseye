# Ralph Progress Log
Started: Fri Jan 23 09:01:14 PST 2026

## Codebase Patterns
- For list editing UIs, use Badge + X button for display, Input + Plus button for adding (see StudioInfoSection)
- `StudioResponse` in `use-studio.ts` must match the Prisma Studio model fields — update it when schema changes
- Settings navigation: use `router.push('/settings')` (dedicated page) — do NOT use `setActiveTab('settings')` (deprecated)
- Standalone scripts use pattern: `import 'dotenv/config'` + `pg.Pool` + `PrismaPg` adapter + `PrismaClient` (see `scripts/seed.ts`)
- Studio cascade-deletes: Users (ActiveStudio), Projects, ReaderPersonas, ExecutiveProfiles, StudioIntelligence. User re-provisions via `/api/auth/provision`.
- Prisma generated client is gitignored (`src/generated/prisma/`) — regenerate with `npx prisma generate` after pulling migrations
- Prisma config is in `prisma.config.ts` (not default), loaded automatically
- Use `npx prisma migrate dev --name <name>` for migrations (connects to Supabase Postgres)
- Studio model is the central entity — users belong to studios, projects belong to studios
- `User.studioId` is a required FK to the active studio (not nullable in current schema)
- PUT endpoints use conditional spread pattern for partial updates: `...(body.field !== undefined && { field: body.field })`
- GET endpoints return full Prisma objects — new schema fields are automatically included in responses
- API routes need try/catch around encrypt/decrypt and DB operations — `ENCRYPTION_KEY` env var can throw if missing
- The `encrypt()` function in `src/lib/encryption.ts` throws if `ENCRYPTION_KEY` is not set or not 32-byte hex
- Toast store is at `@/stores/toast-store` — use `useToastStore((s) => s.addToast)` for notifications
- Settings API is at `/api/settings` with GET/PUT/DELETE for API key management
- POST /api/studio creates a new studio + user record (handles both new and existing auth users)
- On app load, validate studio exists server-side before trusting localStorage state — use `GET /api/studio` which returns 404 if studio is deleted
- After studio migration/deletion, User records are cascade-deleted — provision flow returns `needsStudio: true` for the client to call POST /api/studio

---

## 2026-01-23 09:02 PST - US-001
- What was implemented: Added `pov String?`, `pillars String[] @default([])`, `beliefs String[] @default([])`, `mandates String[] @default([])` fields to the Studio model in prisma/schema.prisma
- Files changed: `prisma/schema.prisma`, `prisma/migrations/20260123170210_add_studio_identity_fields/migration.sql`
- **Learnings for future iterations:**
  - The generated Prisma client in `src/generated/prisma/` is gitignored — don't try to commit it
  - Migration applies directly to the live Supabase database via `prisma migrate dev`
  - String[] fields with `@default([])` map to PostgreSQL TEXT[] with DEFAULT '{}'
  - Typecheck passes cleanly after schema changes since generated types aren't committed
---

## 2026-01-23 - US-002
- What was implemented: Updated PUT /api/studio to accept optional `pov`, `pillars`, `beliefs`, and `mandates` fields using conditional spread pattern. Made `name` optional (partial updates). Added validation for empty updates. GET already returns new fields since Prisma returns full objects.
- Files changed: `src/app/api/studio/route.ts`
- **Learnings for future iterations:**
  - The studio PUT endpoint previously required `name` — now all fields are optional for partial updates
  - Prisma `findUnique` returns all model fields by default, so new schema fields appear in GET responses without code changes
  - The conditional spread pattern `...(body.field !== undefined && { field: body.field })` allows `null` values to be set (for nullable fields like `pov`)
  - An empty `data` object to Prisma `update` would be a no-op — validate at least one field is provided
---

## 2026-01-23 - US-003
- What was implemented: Added try/catch error handling to all three API route handlers (GET, PUT, DELETE) in `/api/settings/route.ts`. Each handler now catches errors from encrypt/decrypt and DB operations, logs them server-side with `console.error`, and returns specific error messages to the client. Also improved the client-side catch in `settings-view.tsx` to surface the actual error message instead of a generic string.
- Files changed: `src/app/api/settings/route.ts`, `src/components/settings/settings-view.tsx`
- **Learnings for future iterations:**
  - The root cause of "Failed to save API key" was unhandled throws from `encrypt()` when `ENCRYPTION_KEY` env var is missing — the error went to a generic 500 with no body
  - The client-side `settings-view.tsx` already had proper success feedback (toast + masked key display) — the issue was purely server-side error handling
  - Always wrap `encrypt`/`decrypt` calls in try/catch since they depend on env vars that may not be set in all environments
  - The `UserSettings` upsert pattern works correctly — no schema/FK issues
---

## 2026-01-23 - US-004
- What was implemented: Created `scripts/clear-all-studios.ts` — a one-time migration script that deletes all Studio records (cascade-deletes projects, drafts, deliverables, focus sessions, reader personas, executive profiles, studio intelligence, and users), cleans up Supabase Storage files in the 'scripts' bucket, and cleans up orphaned ResourceArchive records.
- Files changed: `scripts/clear-all-studios.ts`
- **Learnings for future iterations:**
  - `User.studioId` is a required FK with `onDelete: Cascade` on the Studio relation — deleting a studio cascade-deletes its active users. Users re-provision via `/api/auth/provision` on next login.
  - The seed script pattern (`import 'dotenv/config'` + `pg.Pool` + `PrismaPg` adapter + `PrismaClient`) is the standard way to write standalone scripts in this project.
  - Supabase Storage `list()` defaults to root folder and `remove()` accepts an array of file paths.
  - `ResourceArchive` records are not FK-linked to studios — they need separate cleanup.
  - The provision endpoint (`/api/auth/provision`) hard-codes `DEFAULT_STUDIO_ID = 'default-studio-id'` — after clearing studios, this will need updating (see US-009).
---

## 2026-01-23 - US-005
- What was implemented: Added "Studio Info" as the first tab in Studio Config with POV textarea, and editable lists (add/remove) for Pillars, Beliefs, and Mandates. Updated `StudioResponse` type to include identity fields. Save calls PUT /api/studio and invalidates studioKeys.studio.
- Files changed: `src/components/studio/studio-view.tsx`, `src/hooks/use-studio.ts`
- **Learnings for future iterations:**
  - The `StudioResponse` type in `use-studio.ts` must be updated when new fields are added to the Prisma schema — the hook returns the full Prisma object but the TS type was narrower
  - For list editing UIs (add/remove items), use Badge + X button for display and Input + Plus button for adding — this is now the established pattern in the Studio Info section
  - The `initialized` state pattern (used in SettingsSection and ProfileSection) is the standard way to sync form state with async-fetched data in this codebase
  - `grid-cols-5` with `max-w-lg` is used for the 5-tab layout; previously it was `grid-cols-4` with `max-w-md`
  - Default tab changed from `'readers'` to `'info'` since Studio Info is now the first tab
---

## 2026-01-23 - US-006
- What was implemented: Created dedicated `/settings` page at `src/app/settings/page.tsx` with three sections: User Settings (display name, avatar upload, email), API Keys (Anthropic key with validation/save/delete), and Account Settings (sign out). Header has back button using `router.back()`. Page uses existing middleware auth protection.
- Files changed: `src/app/settings/page.tsx` (new file)
- **Learnings for future iterations:**
  - The existing Supabase middleware already protects all routes except `/login`, `/auth`, `/signup` — no additional auth guards needed for new pages
  - The `settings-view.tsx` component is a reusable reference for API key UI but is a standalone component (not a page) — for the /settings page, the logic was inlined into section components
  - The `ProfileSection` in `studio-view.tsx` uses the "initialized state" pattern (`nameInitialized` flag) to sync form state with async data — this pattern was replicated in the new page
  - Supabase client-side signOut uses `createClient()` from `@/lib/supabase/client` + `router.push('/login')` + `router.refresh()` — the server-side route at `/auth/signout` is an alternative but client-side is simpler for SPAs
  - Card sections on this page use `rounded-xl border border-border/50 bg-surface p-6` pattern instead of the Card component — consistent with settings-view.tsx styling
---

## 2026-01-23 - US-007
- What was implemented: Removed `ProfileSection` and `SignOutSection` components from the Studio Config Settings tab. The Settings tab now only shows `SettingsSection` (studio name input with save) and `DangerZoneSection` (delete studio with confirmation). Deleted the component code entirely and cleaned up unused imports (`useRouter`, `createClient`, `useUserProfile`, `useUpdateDisplayName`, `useUploadAvatar`, `UserAvatar`, `Upload`, `LogOut`).
- Files changed: `src/components/studio/studio-view.tsx`
- **Learnings for future iterations:**
  - The `SignOutSection` was rendered inside `SettingsSection` (not as a sibling in the TabsContent) — check component internals when removing rendered components
  - After removing components, always grep for their named imports to confirm they're not referenced elsewhere in the codebase
  - This file went from ~1537 lines to ~1339 lines — significant cleanup of user-level concerns now handled by `/settings` page
---

## 2026-01-23 - US-008
- What was implemented: Added UserAvatar component to the app shell sidebar (desktop) and bottom tab bar (mobile) that navigates to `/settings` on click. Removed the old Settings gear icon from the desktop nav rail. Updated the "Go to Settings" button in scout-chat.tsx to use `router.push('/settings')` instead of `setActiveTab('settings')`. Avatar shows tooltip with display name, email, or fallback 'Settings'.
- Files changed: `src/components/layout/app-shell.tsx`, `src/components/scout/scout-chat.tsx`
- **Learnings for future iterations:**
  - The `TabId` type in `app-store.ts` still includes `'settings'` — it's now dead code but harmless. Could be removed in a future cleanup.
  - The `activeTab !== 'settings'` check in the context bar conditional remains but is unreachable from UI — safe to leave.
  - `scout-chat.tsx` had a "Go to Settings" button that used `useAppStore.getState().setActiveTab('settings')` — when moving settings to a dedicated page, grep for all `setActiveTab('settings')` references.
  - The mobile bottom tab bar uses raw buttons (not `MobileTabButton` component) for the avatar since it's not a tab-style icon but a circular avatar.
---

## 2026-01-23 - US-009
- What was implemented: Handle empty studio state after migration. Created POST /api/studio endpoint for studio creation. Updated page.tsx to validate studios exist on the server (handles stale localStorage). Created CreateStudioPrompt component shown when no studios exist. Updated getCurrentUser in auth.ts to return null if user doesn't exist (instead of creating with hardcoded DEFAULT_STUDIO_ID). Updated provision endpoint to not create users with hardcoded studio IDs.
- Files changed: `src/app/api/studio/route.ts` (added POST handler), `src/app/page.tsx` (studio validation + create prompt), `src/components/studio/create-studio-prompt.tsx` (new), `src/lib/auth.ts` (removed hardcoded DEFAULT_STUDIO_ID), `src/app/api/auth/provision/route.ts` (removed hardcoded DEFAULT_STUDIO_ID, returns needsStudio flag)
- **Learnings for future iterations:**
  - After clearing studios, `User` records cascade-delete too (FK with onDelete: Cascade). Users don't exist in the DB after migration — `getCurrentUser` returns null, and the POST /api/studio endpoint handles creating both the studio and user record.
  - The Zustand persist middleware loads stale data from localStorage before React effects run — always validate server-side before trusting local state.
  - The `addStudio` Zustand action doesn't check for duplicates — when syncing with server, use `setStudios([studioData])` to replace rather than append.
  - The provision endpoint previously created users linked to a non-existent `DEFAULT_STUDIO_ID` — this was a silent FK constraint violation waiting to happen. Now it returns a flag indicating the client should create a studio first.
  - For studio creation, slug is derived from name: `name.toLowerCase().replace(/[^a-z0-9]+/g, '-')`. The `@@unique([ownerId, slug])` constraint means two studios owned by the same user can't have the same slug.
---
