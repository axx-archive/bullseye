# Ralph Progress Log
Started: Fri Jan 23 05:42:50 PST 2026

## Codebase Patterns
- Prisma generated client outputs to `src/generated/prisma` and is gitignored — regenerate with `npx prisma generate`
- API routes use `include` (not `select`) so new model fields are automatically returned
- TypeScript types are manually maintained in `src/types/index.ts` — keep in sync with Prisma schema
- Optimistic updates in React Query hooks (e.g., `use-projects.ts`) must include all required fields from the interface
- Commit message format: `feat: [Story ID] - [Story Title]`
- Encryption utility at `src/lib/encryption.ts` uses AES-256-GCM with ENCRYPTION_KEY env var (32-byte hex)
- UserSettings model stores encrypted API keys — use `encrypt()`/`decrypt()` from encryption.ts
- New tabs: add to `TabId` union in app-store.ts, `renderContent` switch in page.tsx, nav rail + mobile nav in app-shell.tsx
- Toast: `useToastStore((s) => s.addToast)` then `addToast('msg', 'success'|'error'|'warning'|'info')`
- API key retrieval: use `getUserApiKey(userId)` from `src/lib/auth.ts` — returns decrypted key or null
- Agent SDK `query()` accepts `env: { ...process.env, ANTHROPIC_API_KEY: key }` to pass user's API key
- Anthropic SDK (`@anthropic-ai/sdk`): pass `{ apiKey }` to constructor for per-request key
- SSE error handling in `event-router.ts`: parses JSON body for error messages on non-200 responses
- Scout chat error UI: check `m.content.includes('API key in Settings')` to differentiate API key errors from generic errors
- `ProjectWithCount` (exported from `use-projects.ts`) includes `studio: { id, name }` — use this for grouping/display
- Projects API returns studio info and orders by `sortOrder asc, updatedAt desc`

---

## 2026-01-23 - US-001
- Added `EvaluationStatus` enum (UNDER_CONSIDERATION, APPROVED, REJECTED) to Prisma schema
- Added `evaluationStatus` (default: UNDER_CONSIDERATION) and `sortOrder` (default: 0) fields to Project model
- Generated and applied migration `20260123134415_add_evaluation_status_and_sort_order`
- Updated `src/types/index.ts` with `EvaluationStatus` type and new fields on `Project` interface
- Fixed optimistic update in `src/hooks/use-projects.ts` to include new required fields
- Files changed: prisma/schema.prisma, src/types/index.ts, src/hooks/use-projects.ts, prisma/migrations/
- **Learnings for future iterations:**
  - When adding new required fields to the Project interface, check `use-projects.ts` optimistic updates
  - The migration_lock.toml file is created on first migration and should be committed
  - Prisma `include` returns all scalar fields by default, so API routes don't need changes for new fields
---

## 2026-01-23 - US-002
- Added `UserSettings` model to Prisma schema with: id, userId (unique, relation to User), claudeApiKeyEncrypted, claudeApiKeyIv, createdAt, updatedAt
- Added `settings` relation on User model pointing to UserSettings
- Generated and applied migration `20260123134700_add_user_settings`
- Created encryption utility at `src/lib/encryption.ts` using AES-256-GCM
- Utility exports `encrypt(plaintext)` returning `{ ciphertext, iv }` and `decrypt(ciphertext, iv)` returning plaintext
- Added ENCRYPTION_KEY to `.env.example` with comment explaining format
- Files changed: prisma/schema.prisma, src/lib/encryption.ts (new), .env.example, prisma/migrations/
- **Learnings for future iterations:**
  - AES-256-GCM auth tag is appended to ciphertext with `:` separator for storage in a single field
  - IV (12 bytes for GCM) stored separately to allow decryption
  - The encryption utility validates key length at runtime — will throw clear error if misconfigured
---

## 2026-01-23 - US-003
- Created GET/PUT/DELETE `/api/settings` route at `src/app/api/settings/route.ts`
- GET returns `{ hasApiKey: boolean, maskedKey: string | null }` — decrypts key to show last 4 chars
- PUT accepts `{ claudeApiKey: string }`, validates `sk-ant-` prefix, encrypts and stores via upsert
- DELETE nulls out the encrypted key fields (keeps the UserSettings record)
- All routes validate auth via `getCurrentUser()` — return 401 if unauthenticated
- Files changed: src/app/api/settings/route.ts (new)
- **Learnings for future iterations:**
  - Use `db.userSettings.upsert()` for create-or-update semantics on 1:1 relations
  - Prisma client must be regenerated (`npx prisma generate`) after schema changes before types are available
  - For masked key display, decrypt to get the full key but only expose last 4 chars
  - DELETE route nulls fields rather than deleting the record — avoids needing to recreate on next PUT
---

## 2026-01-23 - US-004
- Created `src/components/settings/settings-view.tsx` with full API key management UI
- Added `'settings'` to `TabId` type in `src/stores/app-store.ts`
- Added Settings tab (Settings2 gear icon) to app-shell.tsx nav rail (after project tabs, always accessible)
- Added Settings tab to mobile bottom nav bar
- Added `case 'settings'` to `page.tsx` renderContent switch with SettingsView import
- Excluded 'settings' tab from project context bar display
- Features: password input with show/hide toggle, save button with PUT call, masked key display, trash icon delete with confirmation, validation error styling
- Files changed: src/components/settings/settings-view.tsx (new), src/components/layout/app-shell.tsx, src/app/page.tsx, src/stores/app-store.ts
- **Learnings for future iterations:**
  - `Settings` icon from lucide is already used for the "Studio" tab — use `Settings2` for actual settings
  - Settings tab is always accessible (not gated by `hasProject`) — excluded from context bar like 'home'
  - Toast store uses `addToast(message, variant)` pattern — import from `@/stores/toast-store`
  - The app-shell has both desktop (icon rail) and mobile (bottom bar) nav — must add to both
---

## 2026-01-23 - US-005
- Added `getUserApiKey(userId)` helper to `src/lib/auth.ts` — retrieves and decrypts user's API key from UserSettings
- Updated Scout API route (`src/app/api/scout/route.ts`):
  - Added auth check via `getCurrentUser()`
  - Retrieves user's API key from settings, returns 400 with clear message if missing
  - Passes key via `env: { ...process.env, ANTHROPIC_API_KEY: apiKey }` to Agent SDK `query()`
- Updated Reader chat API route (`src/app/api/reader-chat/route.ts`):
  - Added auth check and API key retrieval
  - Passes user's key to `new AnthropicSDK({ apiKey })` constructor
  - Returns 400 with same "add API key in Settings" message if missing
- Improved SSE error handling in `src/lib/agent-sdk/event-router.ts`:
  - `createSSEConnection` now parses JSON response body on non-200 to extract error message
  - Previously only showed generic "HTTP 400: Bad Request"
- Updated Scout chat UI (`src/components/scout/scout-chat.tsx`):
  - Detects API key errors in error messages and shows tailored message
  - Shows "Go to Settings" button (navigates to settings tab) instead of "Retry" for API key errors
- Files changed: src/lib/auth.ts, src/app/api/scout/route.ts, src/app/api/reader-chat/route.ts, src/lib/agent-sdk/event-router.ts, src/components/scout/scout-chat.tsx
- **Learnings for future iterations:**
  - Agent SDK `query()` uses `env` option to override environment — this is how to inject API keys per-request
  - Anthropic SDK constructor accepts `{ apiKey }` directly for per-request keys
  - SSE connections return JSON (not SSE) on auth/validation errors — event-router must handle both
  - `useAppStore.getState().setActiveTab('settings')` navigates to settings from any component without hook
  - The scout-chat already had pending attachment auto-send logic (useEffect) added in a prior commit
---

## 2026-01-23 - US-006
- Refactored home-view.tsx from a flat project grid to studio-grouped layout with collapsible headers
- Added `groupProjectsByStudio()` utility function that groups projects by their studio and sorts studios alphabetically
- Added collapsible studio headers with ChevronDown icon that rotates on collapse (-rotate-90)
- Used Framer Motion `AnimatePresence` for smooth collapse/expand animations
- Updated projects API route to include `studio: { id, name }` in response and order by `sortOrder asc, updatedAt desc`
- Exported `ProjectWithCount` type from `use-projects.ts` (now includes `studio` field)
- Updated optimistic create in `useCreateProject` to include the new `studio` field
- Collapse state managed in component state via `useState<Set<string>>`
- Each studio header shows project count badge
- Files changed: src/components/home/home-view.tsx, src/app/api/projects/route.ts, src/hooks/use-projects.ts
- **Learnings for future iterations:**
  - Projects API now returns studio name — no extra fetch needed for grouping
  - `ProjectWithCount` is exported from `use-projects.ts` — import from there, not redeclare locally
  - API route uses multi-field orderBy: `[{ sortOrder: 'asc' }, { updatedAt: 'desc' }]`
  - Studio grouping uses `project.studio?.id || project.studioId` for fallback (optimistic creates may lack studio)
  - AnimatePresence with `initial={false}` prevents animation on first render
---

## 2026-01-23 - US-007
- Added `StudioStats` component to home-view.tsx that renders compact stat row below each studio header
- Added `EVALUATION_STATUS_CONFIG` constant mapping evaluation statuses to labels and color classes
- Stats show counts for Under Consideration (amber), Approved (green), Rejected (muted red)
- Only non-zero counts are displayed; component returns null if all counts are zero
- Stats are hidden when studio section is collapsed
- All data computed from existing `projects` query data — no additional API calls
- Files changed: src/components/home/home-view.tsx
- **Learnings for future iterations:**
  - `evaluationStatus` field on `ProjectWithCount` may be undefined for optimistic creates — default to `'UNDER_CONSIDERATION'`
  - Stats row is placed between studio header button and AnimatePresence block (outside collapse animation) but guarded by `!isCollapsed`
  - Use Tailwind color utility classes with opacity modifiers (e.g., `text-red-400/70`) for subtle muted colors
---
