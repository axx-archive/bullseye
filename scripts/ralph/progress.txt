# Ralph Progress Log
Started: Sat Jan 24 07:57:21 PST 2026
---

## Codebase Patterns
- The ScoutChat component uses `useAppStore` (Zustand) for all SCOUT state (chatMessages, readerStates, rightPanelMode, etc.)
- Chat history is loaded via `GET /api/projects/{id}/chat` and persisted via `POST /api/projects/{id}/chat`
- SSE connections are managed via `createSSEConnection` from `@/lib/agent-sdk/event-router`
- `pendingScoutAttachment` in Zustand is set by the upload flow to trigger auto-analysis after a draft upload
- `handleSendMessageRef` pattern is used to avoid stale closures in effects
- `processingAttachmentRef` prevents double-firing of the attachment effect
- TypeScript typecheck: `npx tsc --noEmit`; lint: `npx eslint <file>`
- The project is a Next.js app with Prisma ORM

---

## 2026-01-24 - US-001
- **What was implemented**: Fixed the race condition between chat history loading and pendingScoutAttachment auto-send
- **Files changed**: `src/components/scout/scout-chat.tsx`
- **Fix details**:
  - Added `isHistoryLoaded` state (initially `false`)
  - History loading effect sets `isHistoryLoaded = false` when project changes, then `true` after fetch completes (or immediately if no project)
  - Attachment auto-send effect now checks `isHistoryLoaded` before firing, preventing it from triggering while `clearChat()` or history fetch is in progress
  - Added `isHistoryLoaded` to the attachment effect's dependency array so it re-evaluates once history is ready
- **Learnings for future iterations:**
  - The two key effects in scout-chat.tsx that must coordinate: (1) history loader (watches `currentProject`) and (2) attachment sender (watches `pendingScoutAttachment`)
  - `clearChat()` is called on every project change — any effect that sends messages must wait for it to complete
  - For new projects with no history, the fetch returns an empty array quickly, so the `isHistoryLoaded` flag flips fast
  - The existing `processingAttachmentRef` prevents double-sends but does NOT prevent sends during loading — the new `isHistoryLoaded` state handles that
---
